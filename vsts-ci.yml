# Parallel job definitions
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/phases
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/multiple-phases

# jobs:
# - job: InitialJob
#   strategy:
#     parallel: 2
#   steps:
#   - script: echo hello from initial job
# - job: SubsequentA
#   dependsOn: InitialJob
#   steps:
#   - script: echo hello from subsequent A
# - job: SubsequentB
#   dependsOn: InitialJob
#   steps:
#   - script: echo hello from subsequent B

# running all tests on 1 machine: Cypress tests took 3:00
# load balanced on 2 machines: 1:46
# load balanced with 3 machines: 1:20

jobs:
- job: InitialJob
  strategy:
    parallel: 4
  steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '10.x'
    displayName: 'Install Node.js'

  # VSTS hosted Linux agents already have a LOT of dependencies preinstalled
  # https://github.com/Microsoft/vsts-agent-docker
  # so we don't have to install all recommended Cypress dependencies
  # https://on.cypress.io/continuous-integration#Dependencies
  - script: apt-get update && apt-get install -y libgconf-2-4
    displayName: 'install dependencies'

  - script: npm ci
    displayName: 'Install NPM dependencies'

  # on Linux usually prints /root/.cache/Cypress
  - script: npx cypress cache path
    displayName: 'Cypress cached path'
  - script: npx cypress cache list
    displayName: 'Cypress list of cached versions'

  # always interesting to see build-related environment variables
  # https://docs.microsoft.com/en-us/vsts/pipelines/build/variables?view=vsts
  - script: npm run print-env -- BUILD
    displayName: 'print environment variables that start with BUILD'

  # to record on Cypress dashboard we need to set a secret record key in the CI settings
  # see https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables
  # to access variables tab, go to "Builds" and then click "✏️ Edit" button
  # which opens the settings tabs.
  # then add the variable AND SCROLL TO THE RIGHT to reveal "secret" column

  - script: npm run cy:verify
    displayName: 'Cypress verify'

  - script: npm run test:ci:record:parallel
    displayName: 'Run Cypress tests'
    env:
      CYPRESS_RECORD_KEY: $(cypressKitchensinkRecordKey)
